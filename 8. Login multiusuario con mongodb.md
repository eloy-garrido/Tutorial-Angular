# Login Multiusuario con Angular 20, Express y MongoDB Atlas

## Introducción

Este tutorial te guiará para crear un sistema de login minimalista que identifica dos tipos de usuarios (administrador y estudiante) usando Angular 20, Express.js y MongoDB Atlas. El sistema mostrará diferentes componentes según el tipo de usuario autenticado.

## Requisitos Previos

- Node.js (v18 o superior)
- Angular CLI (v20)
- Cuenta en MongoDB Atlas
- Editor de código (VS Code recomendado)

## Estructura del Proyecto

```
login-multiusuario/
├── backend/
│   ├── package.json
│   ├── server.js
│   └── models/
│       └── User.js
└── frontend/
    ├── src/
    │   ├── app/
    │   │   ├── components/
    │   │   │   ├── login/
    │   │   │   ├── admin/
    │   │   │   └── student/
    │   │   ├── services/
    │   │   └── guards/
    │   └── ...
```

## 1. Configuración de MongoDB Atlas

### 1.1 Crear Base de Datos
1. Accede a [MongoDB Atlas](https://cloud.mongodb.com)
2. Crea un nuevo cluster (gratuito, si ya tienes uno creado olvida este paso)
3. Crea una base de datos llamada `loginApp`
4. Crea una colección llamada `users`

### 1.2 Crear Usuarios Manualmente
Inserta estos documentos en la colección `users`:

```json
[
  {
    "username": "admin",
    "password": "admin123",
    "role": "admin",
    "name": "Administrador"
  },
  {
    "username": "student",
    "password": "student123",
    "role": "student",
    "name": "Estudiante"
  }
]
```

### 1.3 Obtener String de Conexión
- Ve a "Connect" → "Connect your application"
- Copia el string de conexión (reemplaza `<password>` con tu contraseña)

## 2. Backend con Express

### 2.1 Inicializar Proyecto Backend

```bash
mkdir login-multiusuario
cd login-multiusuario
mkdir backend
cd backend
npm init -y
npm install express mongoose cors dotenv
npm install -D nodemon
```

> **Nota:** `nodemon` es opcional pero recomendado para desarrollo, ya que reinicia automáticamente el servidor cuando detecta cambios en el código.

### 2.2 Crear server.js

```javascript
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// Middlewares
app.use(cors());
app.use(express.json());

// Conexión a MongoDB
mongoose.connect(process.env.MONGODB_URI, {
  useNewUrlParser: true,
  useUnifiedTopology: true
});

// Modelo de Usuario
const userSchema = new mongoose.Schema({
  username: String,
  password: String,
  role: String,
  name: String
});

const User = mongoose.model('User', userSchema);

// Ruta de Login
app.post('/api/login', async (req, res) => {
  try {
    const { username, password } = req.body;
    
    const user = await User.findOne({ username, password });
    
    if (user) {
      res.json({
        success: true,
        user: {
          id: user._id,
          username: user.username,
          role: user.role,
          name: user.name
        }
      });
    } else {
      res.status(401).json({
        success: false,
        message: 'Credenciales inválidas'
      });
    }
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Error del servidor'
    });
  }
});

app.listen(PORT, () => {
  console.log(`Servidor corriendo en puerto ${PORT}`);
});
```

### 2.3 Crear .env

```
MONGODB_URI=tu_string_de_conexion_aqui
PORT=3000
```

### 2.4 Actualizar package.json

```json
{
  "name": "backend",
  "version": "1.0.0",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "mongoose": "^7.5.0",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}
```

## 3. Frontend con Angular 20

### 3.1 Crear Proyecto Angular

```bash
cd ..
ng new frontend --routing --style=css --skip-git
cd frontend
npm install zone.js
```

> **Nota:** 
> - Usamos `--skip-git` porque ya tenemos un proyecto con backend y queremos manejar git desde la carpeta raíz del proyecto completo.
> - `zone.js` es necesario para Angular 20 y el manejo de detección de cambios.

### 3.2 Crear Servicio de Autenticación

Los **servicios** en Angular son clases que se encargan de la lógica de negocio y el manejo de datos. A diferencia de los componentes (que manejan la interfaz), los servicios se usan para:

- Comunicarse con APIs (como nuestro backend)
- Compartir datos entre componentes
- Manejar el estado de la aplicación
- Realizar operaciones que no están relacionadas con la UI

En nuestro caso, el servicio de autenticación se encargará de:
- Enviar las credenciales al backend
- Guardar la información del usuario logueado
- Controlar si el usuario está autenticado o no
- Manejar el logout

```bash
ng generate service services/auth
```

Este comando creará automáticamente:
- `src/app/services/auth.ts` - El archivo del servicio
- `src/app/services/auth.spec.ts` - Archivo de pruebas (opcional)

**src/app/services/auth.ts**

```typescript
import { Injectable, signal } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';

export interface User {
  id: string;
  username: string;
  role: string;
  name: string;
}

export interface LoginResponse {
  success: boolean;
  user?: User;
  message?: string;
}

@Injectable({
  providedIn: 'root'
})
export class AuthService {
  private apiUrl = 'http://localhost:3000/api';
  
  // Signals para manejo de estado
  currentUser = signal<User | null>(null);
  isLoggedIn = signal<boolean>(false);

  constructor(private http: HttpClient) {}

  login(username: string, password: string): Observable<LoginResponse> {
    return this.http.post<LoginResponse>(`${this.apiUrl}/login`, {
      username,
      password
    });
  }

  setUser(user: User) {
    this.currentUser.set(user);
    this.isLoggedIn.set(true);
    localStorage.setItem('currentUser', JSON.stringify(user));
  }

  logout() {
    this.currentUser.set(null);
    this.isLoggedIn.set(false);
    localStorage.removeItem('currentUser');
  }

  checkStoredUser() {
    const storedUser = localStorage.getItem('currentUser');
    if (storedUser) {
      const user = JSON.parse(storedUser);
      this.setUser(user);
    }
  }
}
```

### 3.3 Crear Componente de Login

```bash
ng generate component login
```

**src/app/login/login.ts**

```typescript
import { Component, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { AuthService } from '../services/auth';

@Component({
  selector: 'app-login',
  standalone: true,
  imports: [CommonModule, FormsModule],
  template: `
    <div class="login-container">
      <div class="login-form">
        <h2>Iniciar Sesión</h2>
        
        <form (ngSubmit)="onLogin()">
          <div class="form-group">
            <label>Usuario:</label>
            <input 
              type="text" 
              [(ngModel)]="username" 
              name="username"
              required>
          </div>
          
          <div class="form-group">
            <label>Contraseña:</label>
            <input 
              type="password" 
              [(ngModel)]="password" 
              name="password"
              required>
          </div>
          
          <button type="submit" [disabled]="loading()">
            {{ loading() ? 'Cargando...' : 'Ingresar' }}
          </button>
        </form>
        
        @if (error()) {
          <div class="error">{{ error() }}</div>
        }
        
        <div class="demo-users">
          <h3>Usuarios de Prueba:</h3>
          <p><strong>Admin:</strong> admin / admin123</p>
          <p><strong>Estudiante:</strong> student / student123</p>
        </div>
      </div>
    </div>
  `,
  styles: [`
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f5f5f5;
    }
    
    .login-form {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    
    input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    button {
      width: 100%;
      padding: 0.75rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .error {
      color: red;
      margin-top: 1rem;
      text-align: center;
    }
    
    .demo-users {
      margin-top: 2rem;
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: 4px;
    }
    
    .demo-users h3 {
      margin-top: 0;
      color: #666;
    }
    
    .demo-users p {
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }
  `]
})
export class LoginComponent {
  username = '';
  password = '';
  loading = signal(false);
  error = signal('');

  constructor(private authService: AuthService) {}

  onLogin() {
    if (!this.username || !this.password) {
      this.error.set('Por favor complete todos los campos');
      return;
    }

    this.loading.set(true);
    this.error.set('');

    this.authService.login(this.username, this.password).subscribe({
      next: (response) => {
        this.loading.set(false);
        if (response.success && response.user) {
          this.authService.setUser(response.user);
        } else {
          this.error.set(response.message || 'Error de autenticación');
        }
      },
      error: (err) => {
        this.loading.set(false);
        this.error.set('Error de conexión con el servidor');
      }
    });
  }
}
```

### 3.4 Crear Componente Admin

```bash
ng generate component admin
```

**src/app/admin/admin.ts**

```typescript
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { AuthService } from '../services/auth';

@Component({
  selector: 'app-admin',
  standalone: true,
  imports: [CommonModule],
  template: `
    <div class="admin-container">
      <div class="header">
        <h1>Panel de Administrador</h1>
        <div class="user-info">
          <span>Bienvenido, {{ authService.currentUser()?.name }}</span>
          <button (click)="logout()" class="logout-btn">Cerrar Sesión</button>
        </div>
      </div>
      
      <div class="content">
        <div class="card">
          <h2>Funciones de Administrador</h2>
          <ul>
            <li>Gestionar usuarios</li>
            <li>Ver reportes</li>
            <li>Configurar sistema</li>
            <li>Administrar contenido</li>
          </ul>
        </div>
        
        <div class="card">
          <h2>Estadísticas</h2>
          <div class="stats">
            <div class="stat-item">
              <h3>Usuarios Activos</h3>
              <p>25</p>
            </div>
            <div class="stat-item">
              <h3>Estudiantes</h3>
              <p>20</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  `,
  styles: [`
    .admin-container {
      min-height: 100vh;
      background-color: #f8f9fa;
    }
    
    .header {
      background-color: #343a40;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .logout-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .content {
      padding: 2rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
    }
    
    .card {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stats {
      display: flex;
      gap: 2rem;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-item h3 {
      margin: 0;
      color: #666;
      font-size: 0.9rem;
    }
    
    .stat-item p {
      margin: 0.5rem 0 0 0;
      font-size: 2rem;
      font-weight: bold;
      color: #007bff;
    }
  `]
})
export class AdminComponent {
  constructor(public authService: AuthService) {}

  logout() {
    this.authService.logout();
  }
}
```

### 3.5 Crear Componente Student

```bash
ng generate component student
```

**src/app/student/student.ts**

```typescript
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { AuthService } from '../services/auth';

@Component({
  selector: 'app-student',
  standalone: true,
  imports: [CommonModule],
  template: `
    <div class="student-container">
      <div class="header">
        <h1>Portal del Estudiante</h1>
        <div class="user-info">
          <span>Bienvenido, {{ authService.currentUser()?.name }}</span>
          <button (click)="logout()" class="logout-btn">Cerrar Sesión</button>
        </div>
      </div>
      
      <div class="content">
        <div class="card">
          <h2>Mis Cursos</h2>
          <div class="course-list">
            <div class="course-item">
              <h3>Matemáticas</h3>
              <p>Progreso: 75%</p>
            </div>
            <div class="course-item">
              <h3>Historia</h3>
              <p>Progreso: 60%</p>
            </div>
            <div class="course-item">
              <h3>Ciencias</h3>
              <p>Progreso: 90%</p>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h2>Tareas Pendientes</h2>
          <ul>
            <li>Ensayo de Historia - Vence: 15/12/2024</li>
            <li>Ejercicios de Matemáticas - Vence: 18/12/2024</li>
            <li>Proyecto de Ciencias - Vence: 20/12/2024</li>
          </ul>
        </div>
      </div>
    </div>
  `,
  styles: [`
    .student-container {
      min-height: 100vh;
      background-color: #f8f9fa;
    }
    
    .header {
      background-color: #28a745;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .logout-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .content {
      padding: 2rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
    }
    
    .card {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .course-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .course-item {
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: 4px;
      border-left: 4px solid #28a745;
    }
    
    .course-item h3 {
      margin: 0 0 0.5rem 0;
      color: #333;
    }
    
    .course-item p {
      margin: 0;
      color: #666;
    }
  `]
})
export class StudentComponent {
  constructor(public authService: AuthService) {}

  logout() {
    this.authService.logout();
  }
}
```

### 3.6 Actualizar App Component

**src/app/app.ts**

```typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { HttpClientModule } from '@angular/common/http';
import { AuthService } from './services/auth';
import { LoginComponent } from './login/login';
import { AdminComponent } from './admin/admin';
import { StudentComponent } from './student/student';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [
    CommonModule, 
    HttpClientModule, 
    LoginComponent, 
    AdminComponent, 
    StudentComponent
  ],
  template: `
    @if (!authService.isLoggedIn()) {
      <app-login></app-login>
    } @else {
      @if (authService.currentUser()?.role === 'admin') {
        <app-admin></app-admin>
      } @else if (authService.currentUser()?.role === 'student') {
        <app-student></app-student>
      }
    }
  `
})
export class AppComponent implements OnInit {
  constructor(public authService: AuthService) {}

  ngOnInit() {
    this.authService.checkStoredUser();
  }
}
```

### 3.7 Configurar app.config.ts

**src/app/app.config.ts**

```typescript
import { ApplicationConfig, provideZoneChangeDetection } from '@angular/core';
import { provideRouter } from '@angular/router';
import { provideHttpClient } from '@angular/common/http';

import { routes } from './app.routes';

export const appConfig: ApplicationConfig = {
  providers: [
    provideZoneChangeDetection({ eventCoalescing: true }),
    provideRouter(routes),
    provideHttpClient()
  ]
};
```

### 3.8 Configurar main.ts

**src/main.ts**

```typescript
import 'zone.js';
import { bootstrapApplication } from '@angular/platform-browser';
import { AppComponent } from './app/app';
import { appConfig } from './app/app.config';

bootstrapApplication(AppComponent, appConfig)
  .catch(err => console.error(err));
```

### 3.9 Configurar app.config.server.ts

**src/app/app.config.server.ts**

```typescript
import { mergeApplicationConfig, ApplicationConfig } from '@angular/core';
import { provideServerRendering } from '@angular/platform-server';
import { provideHttpClient } from '@angular/common/http';
import { appConfig } from './app.config';

const serverConfig: ApplicationConfig = {
  providers: [
    provideServerRendering(),
    provideHttpClient()
  ]
};

export const config = mergeApplicationConfig(appConfig, serverConfig);
```

### 3.10 Configurar main.server.ts

**src/main.server.ts**

```typescript
import 'zone.js/node';
import { bootstrapApplication, BootstrapContext } from '@angular/platform-browser';
import { AppComponent } from './app/app';
import { config } from './app/app.config.server';

const bootstrap = (context: BootstrapContext) => bootstrapApplication(AppComponent, config, context);

export default bootstrap;
```
### 3.11 Configurar app.routes.server.ts


```typescript
import { RenderMode, ServerRoute } from '@angular/ssr';

export const serverRoutes: ServerRoute[] = [
  {
    path: '**',
    renderMode: RenderMode.Server
  }
];

```


## 4. Ejecución del Proyecto

### 4.1 Ejecutar Backend

```bash
cd backend
npm start
```

**Para desarrollo con recarga automática (opcional):**
```bash
npm run dev
```

El servidor estará disponible en `http://localhost:3000`

### 4.2 Ejecutar Frontend

```bash
cd frontend
ng serve
```

La aplicación estará disponible en `http://localhost:4200`

## 5. Pruebas del Sistema

### Usuarios de Prueba:

1. **Administrador:**
   - Usuario: `admin`
   - Contraseña: `admin123`
   - Muestra: Panel de administrador con estadísticas

2. **Estudiante:**
   - Usuario: `student`
   - Contraseña: `student123`
   - Muestra: Portal del estudiante con cursos y tareas

## 6. Características del Sistema

- ✅ Autenticación con MongoDB Atlas
- ✅ Dos tipos de usuarios (admin/student)
- ✅ Componentes diferentes según el rol
- ✅ Uso de Angular 20 Signals
- ✅ Persistencia de sesión en localStorage
- ✅ Interfaz responsive y moderna
- ✅ Código minimalista y funcional

## Les comparto un repo con el código completo del proyecto, pero tiene modificaciones para funcionar en producción:
https://github.com/eloy-garrido/login-multiusuario