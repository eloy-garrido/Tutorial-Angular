# 6. Conectar MongoDB y Angular - Tutorial Paso a Paso

## Introducci√≥n

En este tutorial aprender√°s a crear una aplicaci√≥n completa que conecte Angular con MongoDB a trav√©s de un backend en Node.js. Crearemos una peque√±a aplicaci√≥n que permita verificar la conexi√≥n entre ambas tecnolog√≠as mediante operaciones CRUD b√°sicas.

## Requisitos Previos

Antes de comenzar, aseg√∫rate de tener instalado:

- **Node.js** (versi√≥n 18 o superior)
- **Angular CLI** (versi√≥n 17 o superior)
- **MongoDB Atlas** (cuenta gratuita)
- **Git** (para control de versiones)

### Verificar instalaciones

```bash
# Verificar Node.js
node --version

# Verificar Angular CLI
ng version
```

## Arquitectura del Proyecto

```
proyecto-mongodb-angular/
‚îú‚îÄ‚îÄ backend/                 # Servidor Node.js + Express + MongoDB
‚îÇ   ‚îú‚îÄ‚îÄ models/             # Modelos de datos
‚îÇ   ‚îú‚îÄ‚îÄ routes/             # Rutas de la API
‚îÇ   ‚îú‚îÄ‚îÄ config/             # Configuraci√≥n de BD
‚îÇ   ‚îî‚îÄ‚îÄ server.js           # Servidor principal
‚îî‚îÄ‚îÄ frontend/               # Aplicaci√≥n Angular
    ‚îú‚îÄ‚îÄ src/
    ‚îÇ   ‚îú‚îÄ‚îÄ app/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ service/   # Servicios para API
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ components/ # Componentes
    ‚îî‚îÄ‚îÄ ...
```

---

## PASO 1: Configuraci√≥n del Proyecto

### 1.1 Crear la estructura del proyecto

```bash
# Crear directorio principal
mkdir proyecto-mongodb-angular
cd proyecto-mongodb-angular

# Crear directorios
mkdir backend
mkdir frontend
```

### 1.2 Inicializar el backend

```bash
cd backend

# Inicializar proyecto Node.js
npm init -y

# Instalar dependencias principales
npm install express mongoose cors dotenv

# Instalar dependencias de desarrollo
npm install --save-dev nodemon
```

### 1.3 Configurar package.json del backend

Edita el archivo `backend/package.json`:

```json
{
  "name": "mongodb-angular-backend",
  "version": "1.0.0",
  "description": "Backend para conectar MongoDB con Angular",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "dependencies": {
    "express": "^4.18.2",
    "mongoose": "^8.0.0",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}
```

---

## PASO 2: Configurar el Backend (Node.js + Express + MongoDB)

### 2.1 Crear archivo de configuraci√≥n de entorno

Crea `backend/.env`:

#### Para MongoDB Atlas (Recomendado):
```env
# Configuraci√≥n de MongoDB Atlas
MONGODB_URI=mongodb+srv://tu_usuario:tu_password@cluster0.xxxxx.mongodb.net/login?retryWrites=true&w=majority

# Configuraci√≥n del servidor
PORT=3000
NODE_ENV=development
```

#### 1. Configurar acceso a la base de datos

**Crear usuario de base de datos:**
1. En el panel izquierdo, ve a "Database Access"
2. Haz clic en "Add New Database User"
3. Selecciona "Password" como m√©todo de autenticaci√≥n
4. **Username**: Elige un nombre de usuario (ej: `angular_user`)
5. **Password**: Genera una contrase√±a segura (gu√°rdala bien)
6. En "Database User Privileges", selecciona "Read and write to any database"
7. Haz clic en "Add User"

**Configurar acceso de red:**
1. En el panel izquierdo, ve a "Network Access"
2. Haz clic en "Add IP Address"
3. Para desarrollo, puedes usar "Allow Access from Anywhere" (0.0.0.0/0)
   - ‚ö†Ô∏è **Nota**: En producci√≥n, especifica solo las IPs necesarias
4. Haz clic en "Confirm"

#### 4. Obtener la cadena de conexi√≥n

1. Ve a "Database" en el panel izquierdo
2. En tu cluster, haz clic en "Connect"
3. Selecciona "Connect your application" Driver
4. Elige "Node.js" como driver y la versi√≥n m√°s reciente
5. Copia la cadena de conexi√≥n que aparece (debes editar el apartado password con el pass de tu usuario) (sin el menor y mayor que)

La cadena se ver√° as√≠:
```
mongodb+srv://eloegf_db_user:<db_password>@cluster0.yz0kaxz.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0
```

#### 5. Configurar tu archivo .env

Reemplaza los valores en tu archivo `.env`:

```env
# Configuraci√≥n de MongoDB Atlas
# Reemplaza los valores entre < > con tus datos reales
MONGODB_URI=mongodb+srv://angular_user:TU_PASSWORD_AQUI@cluster0.xxxxx.mongodb.net/login?retryWrites=true&w=majority

# Configuraci√≥n del servidor
PORT=3000
NODE_ENV=development
```

#### üìù Ejemplo completo de configuraci√≥n:

Si tu configuraci√≥n de Atlas es:
- **Usuario**: `angular_user`
- **Password**: `MiPassword123!`
- **Cluster**: `cluster0.ab1cd.mongodb.net`
- **Base de datos**: `angular-mongodb-test`

Tu `.env` quedar√≠a:
```env
MONGODB_URI=mongodb+srv://angular_user:MiPassword123!@cluster0.ab1cd.mongodb.net/login?retryWrites=true&w=majority
PORT=3000
NODE_ENV=development
```

#### ‚ö†Ô∏è Consideraciones importantes:

1. **Seguridad del password**: 
   - Si tu contrase√±a contiene caracteres especiales (@, :, /, ?, #, [, ], %), debes codificarlos en URL
   - Ejemplo: `@` se convierte en `%40`, `:` en `%3A`

2. **Nombre de la base de datos**:
   - `angular-mongodb-test` es el nombre de tu base de datos
   - Se crear√° autom√°ticamente cuando insertes el primer documento

3. **Par√°metros adicionales**:
   - `retryWrites=true`: Permite reintentos autom√°ticos de escritura
   - `w=majority`: Garantiza que las escrituras se confirmen en la mayor√≠a de nodos

#### üîç Verificar la conexi√≥n:

Crea el archivo server.js dentro del backend para realizar la comprobaci√≥n.

```javascript
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Conexi√≥n a MongoDB
mongoose.connect(process.env.MONGODB_URI)
.then(() => {
  console.log('‚úÖ Conectado a MongoDB Atlas exitosamente');
})
.catch((error) => {
  console.error('‚ùå Error conectando a MongoDB:', error);
});

// Definir esquema de Usuario (basado en tu estructura real)
const usuarioSchema = new mongoose.Schema({
  nombreCompleto: {
    type: String,
    required: true
  },
  email: {
    type: String,
    required: true,
    unique: true
  },
  edad: Number,
  activo: {
    type: Boolean,
    default: true
  },
  fechaCreacion: String
}, {
  timestamps: true
});

// Crear modelo (usando la colecci√≥n 'usuarios' que ya tienes)
const Usuario = mongoose.model('Usuario', usuarioSchema, 'usuarios');

// Rutas b√°sicas
app.get('/', (req, res) => {
  res.json({ message: 'Servidor funcionando' });
});

app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'OK',
    database: mongoose.connection.readyState === 1 ? 'connected' : 'disconnected'
  });
});

// Obtener todos los usuarios
app.get('/api/users', async (req, res) => {
  try {
    const usuarios = await Usuario.find();
    res.json(usuarios);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Crear nuevo usuario
app.post('/api/users', async (req, res) => {
  try {
    const nuevoUsuario = new Usuario(req.body);
    const usuarioGuardado = await nuevoUsuario.save();
    res.status(201).json(usuarioGuardado);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// Actualizar usuario (para cambiar estado activo)
app.put('/api/users/:id', async (req, res) => {
  try {
    const usuarioActualizado = await Usuario.findByIdAndUpdate(
      req.params.id,
      req.body,
      { new: true }
    );
    res.json(usuarioActualizado);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// Eliminar usuario
app.delete('/api/users/:id', async (req, res) => {
  try {
    await Usuario.findByIdAndDelete(req.params.id);
    res.json({ message: 'Usuario eliminado' });
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// Iniciar servidor
app.listen(PORT, () => {
  console.log(`üöÄ Servidor ejecut√°ndose en puerto ${PORT}`);
});
```

Una vez configurado, puedes verificar que todo funciona ejecutando:

```bash
cd backend
npm run dev
```

Deber√≠as ver en la consola:
```
‚úÖ MongoDB conectado: cluster0-shard-00-00.xxxxx.mongodb.net:27017
üì° Mongoose conectado a MongoDB
```

### 2.2 Crear configuraci√≥n de base de datos

Crea `backend/config/database.js`:

```javascript
const mongoose = require('mongoose');
require('dotenv').config();

const connectDB = async () => {
  try {
    const conn = await mongoose.connect(process.env.MONGODB_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    });

    console.log(`‚úÖ MongoDB conectado: ${conn.connection.host}`);
    
    // Verificar el estado de la conexi√≥n
    mongoose.connection.on('connected', () => {
      console.log('üì° Mongoose conectado a MongoDB');
    });

    mongoose.connection.on('error', (err) => {
      console.error('‚ùå Error de conexi√≥n MongoDB:', err);
    });

    mongoose.connection.on('disconnected', () => {
      console.log('üì¥ Mongoose desconectado');
    });

  } catch (error) {
    console.error('‚ùå Error conectando a MongoDB:', error.message);
    process.exit(1);
  }
};

module.exports = connectDB;
```

---

## PASO 3: Configurar el Frontend (Angular)

### 3.1 Crear aplicaci√≥n Angular

```bash
# Desde el directorio ra√≠z del proyecto
cd frontend

# Crear nueva aplicaci√≥n Angular
ng new angular-mongodb-app --routing --style=css --skip-git --ssr=false

# Navegar al directorio de la aplicaci√≥n
cd angular-mongodb-app

# instalar zone.js
npm install zone.js 
```

### 3.2 Configurar HttpClient

**Archivo: `src/app/app.config.ts`**

Reemplaza el contenido con:

```typescript
import { ApplicationConfig, provideZoneChangeDetection } from '@angular/core';
import { provideRouter } from '@angular/router';
import { provideHttpClient, withInterceptorsFromDi } from '@angular/common/http';

import { routes } from './app.routes';

export const appConfig: ApplicationConfig = {
  providers: [
    provideZoneChangeDetection({ eventCoalescing: true }),
    provideRouter(routes),
    provideHttpClient(withInterceptorsFromDi())
  ]
};
```

### 3.3 Crear interfaces TypeScript

**Archivo: `src/app/interfaces/user.interface.ts`** (crear carpeta `interfaces` si no existe)

```typescript
export interface User {
  _id?: string;
  nombreCompleto: string;
  email: string;
  edad?: number;
  activo?: boolean;
  fechaCreacion?: string;
  createdAt?: string;
  updatedAt?: string;
}

export interface ApiResponse<T> {
  success: boolean;
  message?: string;
  data?: T;
  count?: number;
  error?: string;
}
```

### 3.4 Crear servicio para la API

**Archivo: `src/app/service/user.service.ts`** (crear carpeta `service` si no existe)

```typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { User, ApiResponse } from '../interfaces/user.interface';

@Injectable({
  providedIn: 'root'
})
export class UserService {
  private apiUrl = 'http://localhost:3000/api';

  constructor(private http: HttpClient) { }

  // Obtener todos los usuarios
  getUsers(): Observable<User[]> {
    return this.http.get<User[]>(`${this.apiUrl}/users`);
  }

  // Obtener usuario por ID
  getUserById(id: string): Observable<User> {
    return this.http.get<User>(`${this.apiUrl}/users/${id}`);
  }

  // Crear nuevo usuario
  createUser(user: User): Observable<User> {
    return this.http.post<User>(`${this.apiUrl}/users`, user);
  }

  // Actualizar usuario
  updateUser(id: string, user: User): Observable<User> {
    return this.http.put<User>(`${this.apiUrl}/users/${id}`, user);
  }

  // Eliminar usuario
  deleteUser(id: string): Observable<any> {
    return this.http.delete(`${this.apiUrl}/users/${id}`);
  }

  // Verificar conexi√≥n
  checkConnection(): Observable<any> {
    return this.http.get(`${this.apiUrl}/health`);
  }
}
```

main.ts
```typescript
import 'zone.js';
import { bootstrapApplication } from '@angular/platform-browser';
import { appConfig } from './app/app.config';
import { AppComponent } from './app/app';

bootstrapApplication(AppComponent, appConfig)
  .catch((err) => console.error(err));
```

### 3.5 Crear componente principal

**Archivo: `src/app/app.ts`**

Reemplaza el contenido con:

```typescript
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { UserService } from './service/user.service';
import { User } from './interfaces/user.interface';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './app.html',
  styleUrls: ['./app.css']
})
export class AppComponent implements OnInit {
  title = 'MongoDB + Angular App';
  users: User[] = [];
  newUser: User = { nombreCompleto: '', email: '', edad: 0, activo: true };
  isConnected = false;
  loading = false;
  message = '';

  constructor(private userService: UserService) {}

  ngOnInit() {
    this.checkConnection();
    this.loadUsers();
  }

  // Verificar conexi√≥n con el backend
  checkConnection() {
    this.userService.checkConnection().subscribe({
      next: (response) => {
        this.isConnected = true;
        console.log('‚úÖ Conexi√≥n exitosa:', response);
      },
      error: (error) => {
        this.isConnected = false;
        console.error('‚ùå Error de conexi√≥n:', error);
      }
    });
  }

  // Cargar todos los usuarios
  loadUsers() {
    this.loading = true;
    this.userService.getUsers().subscribe({
      next: (users) => {
        this.users = users;
        this.loading = false;
        this.message = `${users.length} usuarios cargados`;
      },
      error: (error) => {
        console.error('Error cargando usuarios:', error);
        this.loading = false;
        this.message = 'Error cargando usuarios';
      }
    });
  }

  // Crear nuevo usuario
  createUser() {
    if (!this.newUser.nombreCompleto || !this.newUser.email) {
      this.message = 'Nombre completo y email son requeridos';
      return;
    }

    this.loading = true;
    this.userService.createUser(this.newUser).subscribe({
      next: (user) => {
        this.users.unshift(user);
        this.newUser = { nombreCompleto: '', email: '', edad: 0, activo: true };
        this.loading = false;
        this.message = 'Usuario creado exitosamente';
      },
      error: (error) => {
        console.error('Error creando usuario:', error);
        this.loading = false;
        this.message = 'Error creando usuario';
      }
    });
  }

  // Eliminar usuario
  deleteUser(id: string) {
    if (!confirm('¬øEst√°s seguro de eliminar este usuario?')) return;

    this.userService.deleteUser(id).subscribe({
      next: () => {
        this.users = this.users.filter(user => user._id !== id);
        this.message = 'Usuario eliminado exitosamente';
      },
      error: (error) => {
        console.error('Error eliminando usuario:', error);
        this.message = 'Error eliminando usuario';
      }
    });
  }

  // Alternar estado activo del usuario
  toggleUserStatus(user: User) {
    if (!user._id) return;

    const updatedUser = { ...user, activo: !user.activo };
    
    this.userService.updateUser(user._id, updatedUser).subscribe({
      next: (updated) => {
        const index = this.users.findIndex(u => u._id === user._id);
        if (index !== -1) {
          this.users[index] = updated;
        }
        this.message = `Usuario ${updated.activo ? 'activado' : 'desactivado'} exitosamente`;
      },
      error: (error) => {
        console.error('Error actualizando usuario:', error);
        this.message = 'Error actualizando usuario';
      }
    });
  }
}
```

### 3.6 Crear template HTML

**Archivo: `src/app/app.html`**

Reemplaza el contenido con:

```html
<div class="container">
  <header class="header">
    <h1>{{ title }}</h1>
    <div class="connection-status">
      <span [class]="isConnected ? 'connected' : 'disconnected'">
        {{ isConnected ? '‚úÖ Conectado' : '‚ùå Desconectado' }}
      </span>
    </div>
  </header>

  <!-- Mensaje de estado -->
  <div *ngIf="message" class="message">
    {{ message }}
  </div>

  <!-- Formulario para crear usuario -->
   <section class="form-section">
     <h2>Crear Nuevo Usuario</h2>
     <form (ngSubmit)="createUser()" class="user-form">
       <div class="form-group">
         <label for="nombreCompleto">Nombre Completo:</label>
         <input 
           type="text" 
           id="nombreCompleto"
           [(ngModel)]="newUser.nombreCompleto" 
           name="nombreCompleto"
           placeholder="Ingresa el nombre completo"
           required>
       </div>

       <div class="form-group">
         <label for="email">Email:</label>
         <input 
           type="email" 
           id="email"
           [(ngModel)]="newUser.email" 
           name="email"
           placeholder="Ingresa el email"
           required>
       </div>

       <div class="form-group">
         <label for="edad">Edad:</label>
         <input 
           type="number" 
           id="edad"
           [(ngModel)]="newUser.edad" 
           name="edad"
           placeholder="Ingresa la edad"
           min="0"
           max="120">
       </div>

       <div class="form-group">
         <label class="checkbox-label">
           <input 
             type="checkbox" 
             [(ngModel)]="newUser.activo" 
             name="activo">
           Usuario activo
         </label>
       </div>

       <button type="submit" [disabled]="loading" class="btn-primary">
         {{ loading ? 'Creando...' : 'Crear Usuario' }}
       </button>
     </form>
   </section>

   <!-- Lista de usuarios -->
   <section class="users-section">
     <h2>Lista de Usuarios ({{ users.length }})</h2>
     
     <div *ngIf="loading && users.length === 0" class="loading">
       Cargando usuarios...
     </div>

     <div *ngIf="users.length === 0 && !loading" class="no-users">
       No hay usuarios registrados
     </div>

     <div class="users-grid">
       <div *ngFor="let user of users" class="user-card" [class.inactive]="!user.activo">
         <div class="user-header">
           <h3>{{ user.nombreCompleto }}</h3>
           <span class="status-badge" [class.active]="user.activo" [class.inactive]="!user.activo">
             {{ user.activo ? 'Activo' : 'Inactivo' }}
           </span>
         </div>
         
         <div class="user-details">
           <p><strong>Email:</strong> {{ user.email }}</p>
           <p *ngIf="user.edad"><strong>Edad:</strong> {{ user.edad }} a√±os</p>
           <p *ngIf="user.fechaCreacion"><strong>Fecha Creaci√≥n:</strong> {{ user.fechaCreacion }}</p>
           <p><strong>Registrado:</strong> {{ user.createdAt | date:'short' }}</p>
         </div>
         
         <div class="user-actions">
           <button 
             (click)="toggleUserStatus(user)" 
             [class]="user.activo ? 'btn-warning' : 'btn-success'">
             {{ user.activo ? 'Desactivar' : 'Activar' }}
           </button>
           
           <button 
             (click)="deleteUser(user._id!)" 
             class="btn-danger">
             Eliminar
           </button>
         </div>
       </div>
     </div>
   </section>
</div>
```

### 3.7 Agregar estilos CSS

**Archivo: `src/app/app.component.css`**

```css
.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  font-family: Arial, sans-serif;
}

h1 {
  text-align: center;
  color: #333;
}

.connection-section {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 5px;
  margin-bottom: 20px;
  text-align: center;
}

.connected { color: green; }
.disconnected { color: red; }

.form-section {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 5px;
  margin-bottom: 20px;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

.form-group input {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.btn-primary {
  background: #007bff;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-primary:hover {
  background: #0056b3;
}

.users-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 15px;
}

.user-card {
  border: 1px solid #ddd;
  padding: 15px;
  border-radius: 5px;
  background: white;
}

.user-card h3 {
  margin: 0 0 10px 0;
  color: #333;
}

.user-card p {
  margin: 5px 0;
  color: #666;
}

.btn-danger, .btn-warning, .btn-success {
  padding: 5px 10px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  margin: 2px;
}

.btn-danger { background: #dc3545; color: white; }
.btn-warning { background: #ffc107; color: black; }
.btn-success { background: #28a745; color: white; }

.status-badge {
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: bold;
}

.status-badge.active { background: #d4edda; color: #155724; }
.status-badge.inactive { background: #f8d7da; color: #721c24; }
```

---

## PASO 4: Ejecutar la Aplicaci√≥n

### 4.1 Iniciar el servidor backend

En la terminal del backend:

```bash
cd backend
npm start
```

Deber√≠as ver:
```
Servidor corriendo en puerto 3000
‚úÖ Conectado a MongoDB
```

### 4.2 Iniciar la aplicaci√≥n Angular

En otra terminal:

```bash
cd frontend/angular-mongodb-app
ng serve
```

### 4.3 Probar la aplicaci√≥n

1. Abre tu navegador en `http://localhost:4200`
2. Verifica que aparezca "Estado: Conectado" 
3. Prueba crear, editar y eliminar usuarios

## Conclusi√≥n

¬°Felicidades! Has creado exitosamente una aplicaci√≥n completa que conecta Angular con MongoDB. Esta aplicaci√≥n incluye:

‚úÖ **Backend completo** con Node.js, Express y MongoDB  
‚úÖ **API REST** con operaciones CRUD  
‚úÖ **Frontend Angular** con componentes reactivos  
‚úÖ **Verificaci√≥n de conexi√≥n** en tiempo real  
‚úÖ **Gesti√≥n de usuarios** completa  
‚úÖ **Manejo de errores** robusto  
‚úÖ **Interfaz de usuario** intuitiva  

### Pr√≥ximos pasos recomendados:

1. **Seguridad**: Agregar autenticaci√≥n JWT
2. **Testing**: Implementar pruebas unitarias y de integraci√≥n
3. **Deployment**: Desplegar en servicios cloud (Heroku, Vercel, etc.)
4. **Optimizaci√≥n**: Implementar cach√© y optimizaci√≥n de consultas
5. **Monitoreo**: Agregar logs y m√©tricas de rendimiento

### Recursos adicionales:

- [Documentaci√≥n oficial de MongoDB](https://docs.mongodb.com/)
- [Documentaci√≥n oficial de Angular](https://angular.dev/)
- [Mongoose Documentation](https://mongoosejs.com/docs/)
- [Express.js Guide](https://expressjs.com/en/guide/routing.html)

¬°Ahora tienes una base s√≥lida para construir aplicaciones web modernas con Angular y MongoDB!